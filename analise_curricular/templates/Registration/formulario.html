{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IAUPE - An√°lise Curricular UPE {{ data_hoje|date:"Y" }}</title>
    <link rel="stylesheet" href="{% static 'CSS/style.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <script>
    console.log("Script carregado!"); // Verifique no console do navegador se aparece
</script>
        <!-- Cabe√ßalho √∫nico (removi a duplica√ß√£o) -->
        <header class="app-header">
            <h1>
                <img src="{% static 'Logo.ico' %}" alt="" class="logo"> An√°lise Curricular
                {% if selecao_nome %}
                    <span class="selection-name"> - {{ selecao_nome }}</span>
                {% endif %}
            </h1>
            <div class="header-info">
                <div class="candidate-counter">Candidato {{ indice_atual }} de {{ total_candidatos }}</div>
                {% if request.user.is_authenticated %}
                    <div class="user-info">
                      <a href="{% url 'painel_avaliador' selecao_id|default:candidato.selecao.id %}" class="nav-button">
                        Voltar ao Painel
                    </a>
                      <span class="welcome-message">Ol√°, <strong>{{ request.user.username }}</strong></span>
                <a href="{% url 'logout' %}" class="nav-button prev">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg> 
                    Sair
                </a>
            </div>
                {% endif %}
            </div> 
        </header>

        <form method="post" enctype="multipart/form-data" class="evaluation-form" id="evaluationForm">
            {% csrf_token %}

            <!-- Se√ß√£o de Dados do Candidato -->
            <section class="candidate-card">
                <h2 class="section-title">Dados do Candidato</h2>
                <div class="candidate-info-group">
                    {% for field in form.visible_fields %}
                        {% if field.name in 'nome,inscricao,cargo' %}
                        <div class="form-group">
                            <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                            {{ field }}
                            {% if field.errors %}
                                <div class="form-error">{{ field.errors }}</div>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </section>

        <!-- Se√ß√£o de Documentos -->
            <section class="evaluation-section">
                <h2 class="section-title">Documentos do Candidato</h2>
                {% if documentos_candidato %}
                    <ul class="document-list">
                        {% for doc in documentos_candidato %}
                        <li>
                            <a href="{{ doc.url }}" target="_blank" class="document-link">
                                <span class="document-icon">üìÑ</span> {{ doc.nome }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="no-documents-message">Nenhum documento encontrado para este candidato.</p>
                {% endif %}
            </section>

        <!-- Se√ß√µes de Avalia√ß√£o Din√¢micas -->
        {% for field in form.visible_fields %}
            {% if field.name not in 'nome,inscricao,cargo,justificativa,observacao,motivo_nao_possui' %}
            <section class="evaluation-section">
                <h2 class="section-title">{{ field.label }}</h2>
                <div class="form-group">
                    {{ field }}
                    {% if field.errors %}
                        <div class="form-error">{{ field.errors }}</div>
                    {% endif %}
                </div>
            </section>
            {% endif %}
        {% endfor %} 

        <!-- Se√ß√£o de Motivo (condicional) -->
        <section class="evaluation-section" id="motivo-nao-possui-section" style="display: none;">
            <h2 class="section-title">{{ form.motivo_nao_possui.label }}</h2>
            <div class="form-group">
                {{ form.motivo_nao_possui }}
                {% if form.motivo_nao_possui.errors %}
                    <div class="form-error">{{ form.motivo_nao_possui.errors }}</div>
                {% endif %}
            </div>
        </section>

        <!-- Se√ß√£o de Justificativa (condicional) -->
        <section class="evaluation-section" id="justificativa-section" style="display: none;">
            <h2 class="section-title">{{ form.justificativa.label }}</h2>
            <div class="form-group">
                {{ form.justificativa }}
                {% if form.justificativa.errors %}
                    <div class="form-error">{{ form.justificativa.errors }}</div>
                {% endif %}
            </div>
 
        </section>
        <!-- Se√ß√£o de Observa√ß√µes -->
        <section class="evaluation-section">
            <h2 class="section-title">{{ form.observacao.label }}</h2>
            <div class="form-group">
                    {{ form.observacao }}
                    {% if form.observacao.errors %}
                        <div class="form-error">{{ form.observacao.errors }}</div>
                    {% endif %}
                </div>
            </section>

            <!-- Navega√ß√£o -->
            <div class="form-navigation">
                {% if anterior_candidato_id %}
                    <a href="{% url 'analisar_candidato' anterior_candidato_id %}" class="nav-button prev">
                        &larr; Anterior
                    </a>
                {% else %}
                    <span class="nav-button prev disabled">&larr; Anterior</span>
                {% endif %}

                <button type="submit" class="nav-button next" id="submitButton">
                    {% if indice_atual == total_candidatos %}Finalizar{% else %}Pr√≥ximo &rarr;{% endif %}
                </button>
            </div>
        </form>

        <footer class="app-footer">
            <div class="footer-info">
                <span class="date-info">Hoje √© {% now "j \d\e F \d\e Y" %}</span>
                <span class="system-info">Sistema de An√°lise Curricular</span>
            </div>
        </footer>
    </div>

    <!-- Modal de Alerta -->
    <div id="alertModal" class="modal">
        <div class="modal-content">
            <div class="modal-icon">‚ö†Ô∏è</div>
            <h3 class="modal-title" id="modalTitle">Aten√ß√£o</h3>
            <p class="modal-message" id="modalMessage"></p>
            <button class="modal-button" id="modalButton">Entendido</button>
        </div>
    </div>

  <script>
document.addEventListener('DOMContentLoaded', function() {
    // --- 1. SELE√á√ÉO DOS ELEMENTOS ---
    const form = document.getElementById('evaluationForm');
    const motivoSection = document.getElementById('motivo-nao-possui-section');
    const justificativaSection = document.getElementById('justificativa-section');
    const justificativaTextarea = document.getElementById('id_justificativa');
    const modal = document.getElementById('alertModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const modalButton = document.getElementById('modalButton');
    const modalIcon = document.querySelector('#alertModal .modal-icon');

    // Fun√ß√£o para pegar valor selecionado dos radios
    function getRadioValue(name) {
        const checked = document.querySelector(`input[name="${name}"]:checked`);
        return checked ? checked.value : '';
    }

    // --- 2. FUN√á√ïES ---
    function showAlert(title, message, isWarning = false) {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modalButton.textContent = 'Entendi!';
        modalIcon.textContent = isWarning ? '‚ö†Ô∏è' : '‚ùå';
        modalTitle.style.color = isWarning ? '#f0ad4e' : '#d9534f';
        modal.style.display = 'flex';
    }

    function closeModal() {
        modal.style.display = 'none';
    }

    function toggleMotivoEJustificativa() {
        const avaliacaoValue = getRadioValue('avaliacao');
        
        // Mostrar/ocultar motivo_nao_possui
        if (avaliacaoValue === 'Nao possui') {
            motivoSection.style.display = 'block';
            
            // Mostrar/ocultar justificativa se motivo for "Outros"
            const motivoValue = getRadioValue('motivo_nao_possui');
            if (motivoValue === 'outros') {
                justificativaSection.style.display = 'block';
                justificativaTextarea.required = true;
            } else {
                justificativaSection.style.display = 'none';
                justificativaTextarea.required = false;
            }
        } else {
            motivoSection.style.display = 'none';
            justificativaSection.style.display = 'none';
            justificativaTextarea.required = false;
        }
    }

    // --- 3. EVENTOS ---
    // Adiciona evento para todos radios de requisito
    document.querySelectorAll('input[name="requisito"]').forEach(function(radio) {
        radio.addEventListener('change', function() {
            const valorNao = 'Nao';
            if (this.value === valorNao) {
                showAlert(
                    'Candidato Eliminado',
                    'O candidato n√£o possui os requisitos m√≠nimos para o cargo. A avalia√ß√£o pode continuar, mas o status ser√° de eliminado.',
                    true
                );
            }
        });
    });

    // Adiciona evento para todos radios de avaliacao
    document.querySelectorAll('input[name="avaliacao"]').forEach(function(radio) {
        radio.addEventListener('change', toggleMotivoEJustificativa);
    });

    // Adiciona evento para todos radios de motivo_nao_possui
    document.querySelectorAll('input[name="motivo_nao_possui"]').forEach(function(radio) {
        radio.addEventListener('change', toggleMotivoEJustificativa);
    });

    modalButton.addEventListener('click', closeModal);

    form.addEventListener('submit', function(event) {
        const avaliacaoValue = getRadioValue('avaliacao');
        const motivoValue = getRadioValue('motivo_nao_possui');
        
        // Valida√ß√£o para quando "N√£o possui" est√° selecionado
        if (avaliacaoValue === 'Nao possui') {
            // Se motivo for "Outros" e justificativa estiver vazia
            if (motivoValue === 'outros' && !justificativaTextarea.value.trim()) {
                event.preventDefault();
                showAlert(
                    'Justificativa Obrigat√≥ria',
                    'O campo "Justificativa" deve ser preenchido quando o motivo √© "Outros".'
                );
                justificativaTextarea.focus();
            }
            // Se nenhum motivo estiver selecionado
            else if (!motivoValue) {
                event.preventDefault();
                showAlert(
                    'Motivo Obrigat√≥rio',
                    'Por favor, selecione um motivo quando a avalia√ß√£o √© "N√£o possui".'
                );
            }
        }
    });

    // --- 4. INICIALIZA√á√ÉO ---
    toggleMotivoEJustificativa(); // Configura o estado inicial dos campos
 // --- 5. DETEC√á√ÉO DE MUDAN√áAS E SALVAMENTO AUTOM√ÅTICO ---
    const fieldsToWatch = document.querySelectorAll('input[type="radio"], textarea, input[type="text"]');
    let savingTimeout;

    fieldsToWatch.forEach(field => {
        field.addEventListener('change', () => {
            clearTimeout(savingTimeout);

            // Mostrar feedback visual (opcional)
            // Por exemplo, desabilitar o bot√£o de submit ou mostrar uma mensagem "Salvando..."
            // document.getElementById('submitButton').disabled = true;
            // document.getElementById('submitButton').textContent = 'Salvando...';

            savingTimeout = setTimeout(saveFormData, 1000); // Salva ap√≥s 1 segundo de inatividade
        });
    });

    function saveFormData() {
        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest' // Para identificar requisi√ß√µes AJAX no Django
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Atualizar visualmente o status do candidato no painel, se necess√°rio
                console.log('Dados salvos com sucesso!', data);
                // Redirecionar para o painel do avaliador
                // window.location.href = "{% url 'painel_avaliador' selecao_id %}";
            } else {
                showAlert('Erro ao salvar', data.errors || 'Ocorreu um erro ao salvar os dados.');
                console.error('Erro ao salvar dados:', data);
            }
        })
        .catch(error => {
            showAlert('Erro de conex√£o', 'N√£o foi poss√≠vel conectar ao servidor.');
            console.error('Erro de conex√£o:', error);
        })
        .finally(() => {
            // Restaurar feedback visual (opcional)
            // document.getElementById('submitButton').disabled = false;
            // document.getElementById('submitButton').textContent = "{% if indice_atual == total_candidatos %}Finalizar{% else %}Pr√≥ximo &rarr;{% endif %}";
        });
    }
});
</script>

</body>
</html>