{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IAUPE - Análise Curricular UPE 2025</title>
    <link rel="stylesheet" href="{% static 'CSS/style.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1><img src="{% static 'analise_curricular/icone_IAUPE.ico' %}" alt="IAUPE" class="logo"> Análise Curricular</h1>
            <div class="candidate-counter">Candidato {{ indice_atual }} de {{ total_candidatos }}</div>
        </header>

        <form method="post" enctype="multipart/form-data" class="evaluation-form">
            {% csrf_token %}
            
            <section class="candidate-card">
                <h2 class="section-title">Dados do Candidato</h2>
                <div class="candidate-info-group">
                    <div class="form-group">
                        <label for="{{ form.nome.id_for_label }}">Nome do Candidato:</label>
                        {{ form.nome }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.inscricao.id_for_label }}">Número de Inscrição:</label>
                        {{ form.inscricao }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.cargo.id_for_label }}">Cargo/Função:</label>
                        {{ form.cargo }}
                    </div>
                </div>
            </section>

            <section class="evaluation-section">
                <h2 class="section-title">1. Possui Requisitos para o Cargo?</h2>
                <div class="radio-group">
                    {% for choice in form.requisito %}
                    <div class="radio-option">
                        <input type="radio" id="{{ choice.id_for_label }}" name="{{ form.requisito.name }}" value="{{ choice.data.value }}" 
                               {% if choice.data.selected %}checked{% endif %}
                               {% if choice.data.value == '' %}data-placeholder="true"{% endif %}>
                        <label for="{{ choice.id_for_label }}" class="radio-label">
                            <span class="radio-custom"></span>
                            <span class="radio-text">{{ choice.choice_label }}</span>
                        </label>
                    </div>
                    {% endfor %}
                </div>
                {% if form.requisito.errors %}
                    <div class="form-error">{{ form.requisito.errors }}</div>
                {% endif %}
            </section>

            <section class="evaluation-section">
                <h2 class="section-title">2. Avaliação Curricular</h2>
                <div class="radio-group">
                    {% for choice in form.avaliacao %}
                    <div class="radio-option">
                        <input type="radio" id="{{ choice.id_for_label }}" name="{{ form.avaliacao.name }}" value="{{ choice.data.value }}"
                               {% if choice.data.selected %}checked{% endif %}
                               {% if choice.data.value == '' %}data-placeholder="true"{% endif %}>
                        <label for="{{ choice.id_for_label }}" class="radio-label">
                            <span class="radio-custom"></span>
                            <span class="radio-text">{{ choice.choice_label }}</span>
                        </label>
                    </div>
                    {% endfor %}
                </div>
                {% if form.avaliacao.errors %}
                    <div class="form-error">{{ form.avaliacao.errors }}</div>
                {% endif %}

                <div id="justificativa-container" class="form-group" style="display: none;">
                    <label for="{{ form.justificativa.id_for_label }}">Justificativa:</label>
                    {{ form.justificativa }}
                    {% if form.justificativa.errors %}
                        <div class="form-error">{{ form.justificativa.errors }}</div>
                    {% endif %}
                </div>
            </section>

            <section class="evaluation-section">
                <h2 class="section-title">3. Observações Adicionais</h2>
                <div class="form-group">
                    {{ form.observacao }}
                    {% if form.observacao.errors %}
                        <div class="form-error">{{ form.observacao.errors }}</div>
                    {% endif %}
                </div>
            </section>

            <div class="form-navigation">
                {% if anterior_candidato_id %}
                    <a href="{% url 'analisar_candidato_com_id' anterior_candidato_id %}" class="nav-button prev">
                        &larr; Anterior
                    </a>
                {% else %}
                    <button type="button" class="nav-button prev disabled" disabled>
                        &larr; Anterior
                    </button>
                {% endif %}
                
                <button type="submit" class="nav-button next">
                    Próximo &rarr;
                </button>
            </div>
        </form>

        <footer class="app-footer">
            <div class="footer-info">
                <span class="date-info">{{ data_hoje }}</span>
                <span class="system-info">Sistema de Análise Curricular - IAUPE</span>
            </div>
        </footer>
    </div>

    <div id="alertModal" class="modal">
        <div class="modal-content">
            <div class="modal-icon">⚠️</div>
            <h3 class="modal-title" id="modalTitle">Atenção</h3>
            <p class="modal-message" id="modalMessage"></p>
            <button class="modal-button" id="modalButton">Entendido</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos do formulário
            const form = document.querySelector('.evaluation-form');
            const requisitoOptions = document.querySelectorAll('input[name="requisito"]');
            const avaliacaoOptions = document.querySelectorAll('input[name="avaliacao"]');
            const justificativaContainer = document.getElementById('justificativa-container');
            const justificativaTextarea = document.getElementById('id_justificativa');
            
            // Elementos do modal
            const modal = document.getElementById('alertModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalButton = document.getElementById('modalButton');
            
            // Mostrar/ocultar justificativa
            function toggleJustificativa() {
                const selectedAvaliacao = document.querySelector('input[name="avaliacao"]:checked');
                
                if (selectedAvaliacao && selectedAvaliacao.value === 'Nao possui') {
                    justificativaContainer.style.display = 'block';
                    justificativaTextarea.required = true;
                } else {
                    justificativaContainer.style.display = 'none';
                    justificativaTextarea.required = false;
                    justificativaTextarea.value = ''; // Limpa o valor quando oculta
                }
            }
            
            // Mostrar modal de alerta
            function showAlert(title, message) {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modal.style.display = 'flex';
            }
            
            // Event listeners
            avaliacaoOptions.forEach(option => {
                option.addEventListener('change', toggleJustificativa);
            });
            
            requisitoOptions.forEach(option => {
                option.addEventListener('change', function() {
                    // Se a opção selecionada for a placeholder, não faz nada (será validada no submit)
                    if (this.dataset.placeholder === 'true') {
                        return;
                    }
                    if (this.value === 'Nao') {
                        showAlert(
                            'Candidato Eliminado', 
                            'Este candidato não possui requisitos básicos para o cargo, por tanto está eliminado conforme edital. A análise continua. . . '
                        );
                    }
                });
            });
            
            modalButton.addEventListener('click', function() {
                modal.style.display = 'none';
            });
            
            // Validação do formulário
            form.addEventListener('submit', function(e) {
                const selectedRequisito = document.querySelector('input[name="requisito"]:checked');
                const selectedAvaliacao = document.querySelector('input[name="avaliacao"]:checked');
                
                // Validação para "Requisitos para o Cargo"
                if (!selectedRequisito || selectedRequisito.value === '') {
                    e.preventDefault();
                    showAlert(
                        'Campo Obrigatório', 
                        'Por favor, selecione uma opção em "Possui Requisitos para o Cargo?".'
                    );
                    return;
                }
                
                // Validação para "Avaliação Curricular"
                if (!selectedAvaliacao || selectedAvaliacao.value === '') {
                    e.preventDefault();
                    showAlert(
                        'Campo Obrigatório', 
                        'Por favor, selecione uma opção em "Avaliação Curricular".'
                    );
                    return;
                }
                
                // Validação da Justificativa
                if (selectedAvaliacao.value === 'Nao possui' && !justificativaTextarea.value.trim()) {
                    e.preventDefault();
                    showAlert(
                        'Justificativa Necessária', 
                        'Por favor, informe a justificativa para "Não possui" na avaliação curricular.'
                    );
                    return;
                }
            });
            
            // Inicialização
            toggleJustificativa();
            
            // Verifica se a justificativa deve ser exibida inicialmente
            if (document.querySelector('input[name="avaliacao"][value="Nao possui"]:checked')) {
                justificativaContainer.style.display = 'block';
            }
        });
    </script>
</body>
</html>